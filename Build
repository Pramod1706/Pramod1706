---
- name: Schedule a job in Ansible Tower
  hosts: localhost
  vars:
    ansible_prod_token: "{{ lookup('env', 'ANSIBLE_PROD_TOKEN') }}"
    ansible_tower_ssl_ca_cert: "{{ lookup('env', 'ANSIBLE_TOWER_SSL_CA_CERT') }}"
    schedule_date: "2024-10-15T00:00:00Z"  # Example date, replace with actual value
    template_id: "12345"  # Replace with your actual template ID
  tasks:
    - name: Schedule job in Ansible Tower
      uri:
        url: "https://ansible-tower.hc.cloud.uk.hsbc/api/v2/workflow_job_templates/{{ template_id }}/schedules/"
        method: POST
        headers:
          Content-Type: "application/json"
          Authorization: "Bearer {{ ansible_prod_token }}"
        body: >
          {
            "rrule": "DTSTART;TZID=CAT:{{ schedule_date | regex_replace('[^0-9]', '') }} RRULE:FREQ=MINUTELY;INTERVAL=1;COUNT=1",
            "extra_data": {
              "schedule_date": "{{ schedule_date }}"
            }
          }
        status_code: 201
        validate_certs: yes
        client_cert: "{{ ansible_tower_ssl_ca_cert }}"
      register: response

    - name: Show response
      debug:
        var: response
